PERCONADB_PASS=${PERCONADB_PASS:-"$(pwgen -B -s 24 1)"}
chown -R mysql:mysql /data
if [ ! "$(ls -A /data)" ]; then
	mysql_install_db --datadir=/data --user=mysql

	mysqld_safe &
	mysql -e "INSTALL PLUGIN tokudb SONAME 'ha_tokudb.so';"
	mysql -e "INSTALL PLUGIN tokudb_file_map SONAME 'ha_tokudb.so';"
	mysql -e "INSTALL PLUGIN tokudb_fractal_tree_info SONAME 'ha_tokudb.so';"
	mysql -e "INSTALL PLUGIN tokudb_fractal_tree_block_map SONAME 'ha_tokudb.so';"
	mysql -e "INSTALL PLUGIN tokudb_trx SONAME 'ha_tokudb.so';"
	mysql -e "INSTALL PLUGIN tokudb_locks SONAME 'ha_tokudb.so';"
	mysql -e "INSTALL PLUGIN tokudb_lock_waits SONAME 'ha_tokudb.so';"
	mysqladmin -u root shutdown

	mysqld_safe --skip-grant-tables &
	while [ ! -e /run/mysqld/mysqld.sock ]; do
		inotifywait -e create -q /run/mysqld/
	done
	mysql -u root -e "FLUSH PRIVILEGES; CREATE USER '$PERCONADB_USER'@'%' IDENTIFIED BY '$PERCONADB_PASS'; GRANT ALL PRIVILEGES ON *.* TO '$PERCONADB_USER'@'%' WITH GRANT OPTION;"
	if [[ $PERCONADB_DB != "NONE" ]]; then
		mysql -u $PERCONADB_USER -p$PERCONADB_PASS -e "CREATE DATABASE $PERCONADB_DB;"
	fi

	mysqladmin -u $PERCONADB_USER -p$PERCONADB_PASS shutdown
	echo "PerconaDB Username: $PERCONADB_USER"
	echo "PerconaDB Password: $PERCONADB_PASS"
fi
